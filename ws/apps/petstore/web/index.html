
<html>
<head>
 <meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
<title>Petstore</title>

<link rel="stylesheet" type="text/css" href="styles.css"></link>
<script  src="dojo.js" ></script>
<script  src="model.js" ></script>
<script  src="ajax-commons.js" ></script>

<script type="text/javascript">

var isIE;
var gcats = new Map();
var cart;
var account;
var chunkSize = 3;

var completeTable;
var completeField;
var autorow;

var bodyTable;

function checkout() {
    var bindArgs = {
       url:  "checkout?action=startTask",
       mimetype: "text/xml",
       load: function(type, data) {
               processCheckoutCallback(data);
             }
     };
    dojo.io.bind(bindArgs);
}

function showCart() {
    var cartPop = $("cart-popup");
    if (cartPop) {
        cartPop.style.visibility='visible';
    }
}

// callback function for intial request to schedule a task
function processCheckoutCallback(responseXML) {
    var item = responseXML.getElementsByTagName("message")[0];
    showProgressBar(item.firstChild.nodeValue);
}

function showProgressBar(id) {
  var progress = $("progress-popup");
  if (!progress) {
      inject("progressbar.htmf",
             "progressbar.js",
             function(type, data) {
                initProgressBar();
                targetId = id;
                showProgress(0);
                var idiv = window.document.getElementById("task_id");
                idiv.innerHTML = "<div class=\"progressItem\">Processing Order. The transaction id is " + targetId + ".</div>";
                // do the initial poll in 2 seconds
                progress = $("progress-popup");
                progress.style.visibility='visible';
                setTimeout("pollTaskmaster()", 2000);
             });
  } else {
    targetId = id;
    showProgress(0);
    var idiv = window.document.getElementById("task_id");
    idiv.innerHTML = "<div class=\"progressItem\">Processing Order. The transaction id is " + targetId + ".</div>";
    progress.style.visibility='visible';
  }
}

function showSupport() {
  var chat = $("chat-popup");
  if (!chat) {
      inject("support.htmf",
             "support.js",
             function(type, data) {
                 initSupport();
                 chat.style.visibility='visible';
             });
  } else {
    chat.style.visibility='visible';
  }
}

function inject(template, script, initFunc, injectionPoint) {
        var templateArgs = {
            url:  "controller?command=content&target=/" + template,
            mimetype: "text/html",
            load: function(type, data) {
               if (!injectionPoint) injectionPoint = document.createElement("div");
               injectionPoint.innerHTML = data;
               document.firstChild.appendChild(injectionPoint);
               // now load the associated JavaScript
                var bindArgs = {
                    url:  "controller?command=content&target=/" + script,
                    mimetype: "text/javascript",
                    load: initFunc
                };
                dojo.io.bind(bindArgs);
            }
        };
        dojo.io.bind(templateArgs);
}

function init() {

    if (navigator.userAgent.indexOf("ie") != -1) isIE = true;
    completeField = document.getElementById("complete-field");
    var menu = document.getElementById("auto-row");
    autorow = document.getElementById("menu-popup");
    autorow.style.top = (getElementY(completeField) + 30) + "px";
    autorow.style.left = findX(completeField) + 5 +  "px";
    completeTable = document.getElementById("completeTable");
    completeTable.setAttribute("bordercolor", "white");
    // load the cart
    inject("cart.htmf",
           "cart.js",
           function(type, data) {
               initCart();
                cartPop = $("cart-popup");
           });
    // load signin
    inject("signin.htmf",
           "signin.js",
           function(type, data) {
            initSignin();
           });  
}

function doSearch() {
    if (completeField.value == "") {
    } else {
       var bindArgs = {
            url:  "autocomplete?action=complete&id=" + encodeURI(completeField.value),
            mimetype: "text/xml",
            load: function(type, data) {
               processSearch(data);
             }
        };
        dojo.io.bind(bindArgs);
    }
    completeTable.style.visibility='hidden';
    clearTable();
}

function doCompletion() {
    if (completeField.value == "") {
        clearTable();
        completeTable.style.visibility='hidden';
    } else {
        clearTable();
        var bindArgs = {
            url:  "autocomplete?action=complete&id=" + encodeURI(completeField.value),
            mimetype: "text/xml",
            load: function(type, data) {
               autocompleteCallback(data);
             }
        };
        dojo.io.bind(bindArgs);
    }
}

function autocompleteCallback(responseXML) {
    var items = responseXML.getElementsByTagName("id");
    if (items.length <= 0) {
        completeTable.style.visibility='hidden';
        clearTable();
    }  else {
        for (loop = 0; loop < items.length; loop++) {
            var id = responseXML.getElementsByTagName("id")[loop].childNodes[0].nodeValue;
            var name = responseXML.getElementsByTagName("name")[loop].childNodes[0].nodeValue;
            appendAutoComplete(id, name);
        }
    }
}

function clearTable() {
       clearNodes("completeTable");
}

function appendAutoComplete(productId, name) {
    completeTable.style.visibility='visible';
    var firstNameCell;
    var lastNameCell;
    var row;
    var nameCell;
    if (isIE) {
        row = completeTable.insertRow(completeTable.rows.length);
        nameCell = row.insertCell(0);
    } else {
        row = document.createElement("tr");
        nameCell = document.createElement("td");
        row.appendChild(nameCell);
        completeTable.appendChild(row);
    }
    row.className = "popupRow";
    nameCell.setAttribute("bgcolor", "#FFFAFA");
    var linkElement = document.createElement("a");
    linkElement.className = "popupItem";
    linkElement.setAttribute("onclick", "showSearchItem('" + productId + "')");
    linkElement.appendChild(document.createTextNode(name));
    nameCell.appendChild(linkElement);
}

function loadCategories() {
    init();
    var bindArgs = {
       url:  "catalog?command=categories",
       mimetype: "text/xml",
       load: function(type, data) {
               loadCategoriesCallback(data);
             }
     };
    dojo.io.bind(bindArgs);
}

function loadCategoriesCallback(responseXML) {
	var categories = responseXML.getElementsByTagName("id");
    var id = responseXML.getElementsByTagName("id")[0].childNodes[0].nodeValue;
    for (var loop = 0; loop < categories.length; loop++) {
      var itemId = responseXML.getElementsByTagName("id")[loop];
      var itemValue = responseXML.getElementsByTagName("name")[loop];
      var itemSrc = responseXML.getElementsByTagName("image-url")[loop];
      addCategory(itemId.childNodes[0].nodeValue, itemValue.childNodes[0].nodeValue, itemSrc.childNodes[0].nodeValue);
    }
}

function showSearchItem(id) {
      var c = gcats.get("search");
      if (c != null) {
        var i = c.getItemById(id);
        if (i != null) {
            if (completeTable) completeTable.style.visibility='hidden';
            clearTable();
            addCategoryItem("search", i.id,i.image,i.name,i.description,i.price);
            return;
        }
      }
      var bindArgs = {
            url:  "catalog?command=item&id=" + id,
            mimetype: "text/xml",
            load: function(type, data) {
            loadItemCallback(data);
        }
     };
    dojo.io.bind(bindArgs);
    if (completeTable) completeTable.style.visibility='hidden';
    clearTable();
}

function loadCategory(catid) {
    if (gcats.get(catid) == null) {
        var bindArgs = {
            url:  "catalog?command=category&catid=" + catid,
            mimetype: "text/xml",
            load: function(type, data) {
               loadCategoryCallback(catid,data);
             }
        };
        dojo.io.bind(bindArgs);
    } else {
        showCategoryItems(catid,0,chunkSize);
    }
}

function processSearch(responseXML) {
	var categories = responseXML.getElementsByTagName("id");
    var c = new Category("search");
    for (var loop = 0; loop < categories.length; loop++) {
      var id = responseXML.getElementsByTagName("id")[loop].childNodes[0].nodeValue;
      var image = responseXML.getElementsByTagName("image-url")[loop].childNodes[0].nodeValue;
      var name = responseXML.getElementsByTagName("name")[loop].childNodes[0].nodeValue;
      var description = responseXML.getElementsByTagName("description")[loop].childNodes[0].nodeValue;
      var price = responseXML.getElementsByTagName("price")[loop].childNodes[0].nodeValue;
      c.addItem(id,image,name,description,price);
    }
    gcats.put("search", c);
    showCategoryItems("search",0,chunkSize);
}

function loadItemCallback(responseXML) {
      var id = responseXML.getElementsByTagName("id")[0].childNodes[0].nodeValue;
      var image = responseXML.getElementsByTagName("image-url")[0].childNodes[0].nodeValue;
      var name = responseXML.getElementsByTagName("name")[0].childNodes[0].nodeValue;
      var description = responseXML.getElementsByTagName("description")[0].childNodes[0].nodeValue;
      var price = responseXML.getElementsByTagName("price")[0].childNodes[0].nodeValue;
      clearNodes("bodyTable");
      var c = gcats.get("search");
      if (c == null) {
        c= new Category("search");
        gcats.put("search", c);
      }
      c.addItem(id,image,name,description,price);
      addCategoryItem("search", id,image,name,description,price);
}

function loadCategoryCallback(catid, responseXML) {
	var categories = responseXML.getElementsByTagName("id");
    var c = new Category(catid);
    for (var loop = 0; loop < categories.length; loop++) {
      var id = responseXML.getElementsByTagName("id")[loop].childNodes[0].nodeValue;
      var image = responseXML.getElementsByTagName("image-url")[loop].childNodes[0].nodeValue;
      var name = responseXML.getElementsByTagName("name")[loop].childNodes[0].nodeValue;
      var description = responseXML.getElementsByTagName("description")[loop].childNodes[0].nodeValue;
      var price = responseXML.getElementsByTagName("price")[loop].childNodes[0].nodeValue;
      c.addItem(id,image,name,description,price);
    }
    gcats.put(catid, c);
    showCategoryItems(catid,0,chunkSize);
}

function resetBody() {
    var body = $("body");
    body.innerHTML = "";
    bodyTable = document.createElement("table");
    body.appendChild(bodyTable);
    
}

function showCategoryItems(catid, index, count) {
    var c = gcats.get(catid);
    resetBody();

    if (c.length == 0) {
        if (isIE) {
          bodyTable.innerHTML = "<tr><td>No items</td></tr>";
        } else {
            var cell;
            var row;
            resetBody();
            row = document.createElement("tr");
            row.setAttribute("bgcolor", "white");
            cell = document.createElement("td");
            cell.setAttribute("bgcolor", "white");
            cell.setAttribute("nowrap", "true");
            cell.setAttribute("valign", "top");
            cell.appendChild(document.createTextNode( "No items availabe at this time."));
            row.appendChild(cell);
            bodyTable.appendChild(row);
        }
    } else {
        var  loopLength = Number(index) + Number(count);
        for (l = index; l  < loopLength; l++) {
           var i = c.getItem(l);
           addCategoryItem(catid, i.id, i.image,i.name,i.description,i.price);
        }
        var cell;
        var row;
        // put the next and previous links
        row = document.createElement("tr");
        row.setAttribute("bgcolor", "white");

        if (Number(index) >= chunkSize) {
            cell = document.createElement("td");
            cell.setAttribute("bgcolor", "white");
            cell.setAttribute("nowrap", "true");
            cell.setAttribute("valign", "top");
            cell.setAttribute("align", "left");
            var link = document.createElement("a");
            link.appendChild(document.createTextNode("Previous"));
            link.className = "valueListNavigate";
            var prevIndex =  (Number(index) - chunkSize);
            if ((Number(index)  - Number(chunkSize)) < 0) {
               prevIndex = 0;
            }
            link.setAttribute("onclick", "showCategoryItems('" + catid + "','" + prevIndex + "','" + chunkSize + "')");
            cell.appendChild(link);
            row.appendChild(cell);
        }

        }
        if (Number(c.length) > (Number(index) + Number(count)) ) {
            cell = document.createElement("td");
            cell.setAttribute("bgcolor", "white");
            cell.setAttribute("nowrap", "true");
            cell.setAttribute("valign", "top");
            cell.setAttribute("align", "right");
            var link = document.createElement("a");
            link.appendChild(document.createTextNode("Next"));
            link.className = "valueListNavigate";
            var nextCount = count;
            if ((Number(index) + Number(count) + Number(chunkSize)) > Number(c.length)) {
                nextCount = Number(c.length) - (Number(index) + Number(count));
            }
            link.setAttribute("onclick", "showCategoryItems('" + catid + "','" + (Number(index) + chunkSize) + "','" + nextCount + "')");
            cell.appendChild(link);
            row.appendChild(cell);
        }
        bodyTable.appendChild(row);
}

 

function addCategory(id, name, src) {
    var cell;
    var row;
    var sidebar = document.getElementById("sidebar");

    if (isIE) {
    } else {
        row = document.createElement("tr");
        cell = document.createElement("td");
        cell.setAttribute("nowrap", "true");
        cell.setAttribute("valign", "top");
        var img = document.createElement("img");
        img.src = ("images\\" + src);
        img.setAttribute("height", "50");
        img.setAttribute("width", "50");
        var link = document.createElement("a");
        link.className ="category";
        link.appendChild(document.createTextNode(name));
        var url = "loadCategory('" + id + "')";
        link.setAttribute("onClick", url);
        cell.appendChild(img);
        cell.appendChild(link);
        row.appendChild(cell);
        sidebar.appendChild(row);
    }
}

function addCategoryItem(catid, id,image,name,description,price) {
    var cell;
    var cell2;
    var cell3;
    var row;
    if (isIE) {
    } else {
        row = document.createElement("tr");
        row.setAttribute("bgcolor", "white");
        cell = document.createElement("td");
        cell.setAttribute("bgcolor", "white");
        cell.setAttribute("nowrap", "true");
        cell.setAttribute("valign", "top");
        var img = document.createElement("img");
        img.src = ("images\\" + image);
        cell.appendChild(img);
        row.appendChild(cell);
        cell2 = document.createElement("td");
        var dDiv = document.createElement("div")
        dDiv.appendChild(document.createTextNode(name));
        dDiv.className = "itemName";
        cell2.appendChild(dDiv);
        var dDiv2= document.createElement("div");
        dDiv2.appendChild(document.createTextNode(description));
        dDiv2.className = "item";
        cell2.appendChild(dDiv2);
        row.appendChild(cell2);
        var cell3 = document.createElement("td");
        var dDiv3= document.createElement("div");
        dDiv3.appendChild(document.createTextNode("$" + price + "  "));
        dDiv3.className = "item";
        cell3.appendChild(dDiv3);
        var plink = document.createElement("a");
        plink.className ="purchaseItem";
        plink.appendChild(document.createTextNode("Add to Cart"));
        plink.setAttribute("onClick", "purchaseItem('" + catid + "','" + id + "')");
        cell3.appendChild(plink);
        row.appendChild(cell3);
        bodyTable.appendChild(row);
    }
}

function clearNodes(id) {
    var target = document.getElementById(id);
    if (target) target.innerHTML = "";
}

</script>

</head>
<body onload="loadCategories()">


<table border="0" bordercolor="gray" cellpadding="0" cellspacing="0" bgcolor="white" width="100%">
 <tr>
  <td width="100"><img src="images/banner_logo.gif"></td>
  <td>
  <div class="banner">Petstore</div>
  </td>
  <td align="right">
      <form name="autofillform" action="autocomplete"  onsubmit="return false;">
        <input type="hidden" name="action" value="lookupbyname"/>
         <input    type="text"
                size="15"
                autocomplete="off"
                  id="complete-field"
				name="id"
             onkeyup="doCompletion();">
             <input    type="button"
                  id="search-button"
				value="Search"
             onclick="doSearch();">
    </form>
  </td>
  </td>
 </tr>
  <tr bgcolor="gray">
  <td colspan="3"  align="right">
   <a class="menuLink" onclick="showAccount();">Account</a> <span class="menuItem">|</span > <a class="menuLink" onclick="showCart();">Cart</a> <span class="menuItem">|</span > <a class="menuLink" onclick="showSupport();">Support</a>
  </td>
 </tr>
 </table>

 
<table bgcolor="white">
 <tr>
  <td valign="top" width="300"><table id="sidebar"vbgoclor="red" border="0" cellpadding="0"></table></td>
  <td valign="top" width="100%" bgcolor="white">
   <div id="body">
   <table valign="top" id="bodyTable" border="1" bgcolor="red">
     <tr>
      <td>
        <map name="petmap">
        <area onclick="loadCategory('birds')" 
            alt="Birds" 
            coords="72,2,280,250">
        <area onclick="loadCategory('fish')" 
            alt="Fish" 
            coords="2,180,72,250">
        <area onclick="loadCategory('dogs')" 
            alt="Dogs" 
            coords="60,250,130,320">
       <area onclick="loadCategory('reptiles')" 
            alt="Reptiles" 
            coords="140,270,210,340">
        <area onclick="loadCategory('cats')" 
            alt="Cats" 
            coords="225,240,295,310">
        <area onclick="loadCategory('birds')" 
            alt="Birds" 
            coords="280,180,350,250">
        </map>

        <img src="images/splash.gif" 
            alt="Pet Selection Map"
            usemap="#petmap" 
            width="350" 
            height="355" 
        border="0">
     </td>
    </tr>
   </table>
  </div>
   </td>
 </td>
 </tr>
</table>

 <div style="position: absolute; visibility: visible;z-index:5" id="menu-popup">
 <table id="completeTable" border="1" bordercolor="black" cellpadding="0" cellspacing="0" ></table>
 </div>
 
</body>
</html>