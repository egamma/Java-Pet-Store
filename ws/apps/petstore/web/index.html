
<html>
<head>
 <meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
<title>Petstore</title>

<link rel="stylesheet" type="text/css" href="styles.css"></link>
<script  src="dojo.js" ></script>
<script  src="model.js" ></script>
<script  src="ajax-commons.js" ></script>

<script type="text/javascript">
	//var djConfig = {isDebug: true, debugAtAllCosts: true};
</script>
<script type="text/javascript" src="dojo.js"></script>
<script language="JavaScript" type="text/javascript">       
	dojo.require("dojo.widget.HtmlFisheyeList");
	dojo.hostenv.writeIncludes();
    dojo.addOnLoad(function () {
    init();
    showMain();});
</script>

<script>
	function load_app(id){
		alert('Icon '+id+' was clicked');
	}
</script>

<script type="text/javascript">

var isIE;
var gcats = new Map();
var cart;
var account;
var chunkSize = 3;

var bodyRowText;
var itemsElement;

var checkingOut = false;

window.onresize=resized;

window.onclick = handleMouseClick;

function handleMouseClick() {
    clearAutocompletionResults();
    return true;
}

function loadPetstore() {
    init();
    showMain();
}

function resized() {
    // reposition the autocomplete
    var completeField = $("complete-field");
    var autorow = $("menu-popup");
    if (autorow && completeField) {
        autorow.style.top = findY(completeField) + completeField.offsetHeight +  "px";
        autorow.style.left = findX(completeField)  +  "px";
    }
    // reposition the cart to the right
    var cartPop = $("cart-popup");
    if (cartPop) {
        var winX = 430;
        if (!isIE) winX = window.innerWidth - 228;
        else winX = document.body.offsetWidth - 228;
        cartPop.style.top="140px";
        cartPop.style.left= winX +"px";
    }
}

function checkout() {
    var bindArgs = {
       url:  "checkout?action=startTask",
       mimetype: "text/xml",
       load: function(type, data) {
               processCheckoutCallback(data);
             }
     };
    dojo.io.bind(bindArgs);
}

function processCheckoutCallback(responseXML) {
    var item = responseXML.getElementsByTagName("message")[0];
    showProgressBar(item.firstChild.nodeValue);
}

function showMain() {
    inject({template: "main.htmf", injectionPoint: $("bodyCenter")});
    hideSlider();
}

function showProgressBar(id) {
    injectArgs = {
             template: "progressbar.htmf",
             script: "progressbar.js",
             initFunction: function(type, data) {
                initProgressBar();
                targetId = id;
                showProgress(0);
                var idiv = window.document.getElementById("task_id");
                idiv.innerHTML = "<div class=\"progressItem\">Processing Order. The transaction id is " + targetId + ".</div>";
                progress = $("progress-popup");
                progress.style.visibility='visible';
                var shadow= $("progress-popup_shadow");
                if (shadow) {
                    shadow.style.visibility='visible';
                }
                setTimeout("pollTaskmaster()", 2000);
             }
    }
    inject(injectArgs);
}

function init() {
    if (navigator.userAgent.indexOf("ie") != -1) isIE = true;
    var completeField = document.getElementById("complete-field");
    var autorow = document.getElementById("menu-popup");
    autorow.style.top = findY(completeField) + completeField.offsetHeight +  "px";
    autorow.style.left = findX(completeField)  +  "px";

    // load the cart
    var cartArgs = {
            template: "cart.htmf",
            script: "cart.js",
            initFunction: function() {
                initCart();
            }
    };
    inject(cartArgs);
    // load signin
    var signinArgs = {
           template: "signin.htmf",
           script: "signin.js",
           initFunction: function() {
            initSignin();
        }
    };
    inject(signinArgs);  
}

function doSearch() {
    if (completeField.value == "") {
    } else {
       var bindArgs = {
            url:  "autocomplete?action=complete&id=" + encodeURI(completeField.value),
            mimetype: "text/xml",
            load: function(type, data) {
               processSearch(data);
             }
        };
        dojo.io.bind(bindArgs);
    }
    clearAutocompletionResults();
}

function doCompletion() {
    var completeField = $("complete-field");
    if (completeField && completeField.value == "") {
        clearAutocompletionResults();
    } else {
        clearAutocompletionResults();
        var bindArgs = {
            url:  "autocomplete?action=complete&id=" + encodeURI(completeField.value),
            mimetype: "text/xml",
            load: function(type, data) {
               autocompleteCallback(data);
             }
        };
        dojo.io.bind(bindArgs);
    }
}

function autocompleteCallback(responseXML) {
    var items = responseXML.getElementsByTagName("id");
    var completeText = "";
    if (items.length <= 0) {
        clearAutocompletionResults();
        clearNodes("completeTable");
    }  else {
        clearNodes("completeTable");
        for (loop = 0; loop < items.length; loop++) {
            var id = responseXML.getElementsByTagName("id")[loop].childNodes[0].nodeValue;
            var name = responseXML.getElementsByTagName("name")[loop].childNodes[0].nodeValue;
            completeText += "<tr>" +
                        "<td class=\"popupRow\" onmouseover=\"this.className='popupRowHover'\"" +
                        " onmouseout=\"this.className='popupRow'\"" +
                        "<a onclick=\"showSearchItem('" + id + "');return false;\">" + name + "</a>" +
                       "</td></tr>";
        }
        var completeTable = $("completeTable");
        completeTable.innerHTML = completeText;
        completeTable.style.visibility='visible';
    }
}

function clearAutocompletionResults() {
    var popUp = $("menu-popup");
    var completeTable = $("completeTable");
    completeTable.style.visibility='hidden';
    clearNodes("completeTable");
}


function loadCategoriesCallback(responseXML) {
	var categories = responseXML.getElementsByTagName("id");
    var id = responseXML.getElementsByTagName("id")[0].childNodes[0].nodeValue;
    for (var loop = 0; loop < categories.length; loop++) {
      var itemId = responseXML.getElementsByTagName("id")[loop];
      var itemValue = responseXML.getElementsByTagName("name")[loop];
      var itemSrc = responseXML.getElementsByTagName("image-url")[loop];
      addCategory(itemId.childNodes[0].nodeValue, itemValue.childNodes[0].nodeValue, itemSrc.childNodes[0].nodeValue);
    }
}

function loadCategory(catid) {
    if (gcats.get(catid) == null) {
        var bindArgs = {
            url:  "catalog?command=category&catid=" + catid,
            mimetype: "text/xml",
            load: function(type, data) {
               loadCategoryCallback(catid,data);
             }
        };
        dojo.io.bind(bindArgs);
    } else {
        showCategoryItems(catid,0,chunkSize);
    }
}

function processSearch(responseXML) {
	var categories = responseXML.getElementsByTagName("id");
    var c = new Category("search");
    for (var loop = 0; loop < categories.length; loop++) {
      var id = responseXML.getElementsByTagName("id")[loop].childNodes[0].nodeValue;
      var image = responseXML.getElementsByTagName("image-url")[loop].childNodes[0].nodeValue;
      var name = responseXML.getElementsByTagName("name")[loop].childNodes[0].nodeValue;
      var description = responseXML.getElementsByTagName("description")[loop].childNodes[0].nodeValue;
      var price = responseXML.getElementsByTagName("price")[loop].childNodes[0].nodeValue;
      c.addItem(id,image,name,description,price);
    }
    gcats.put("search", c);
    showCategoryItems("search",0,chunkSize);
    showSlider(c);
}

function showSearchItem(id) {
   resetBody();
   inject({template: "items.htmf", injectionPoint: $("bodyCenter"), initFunction: function(){getSearchItem(id);}});
}

function getSearchItem(id) {
      var c = gcats.get("search");
      if (c != null) {
        var i = c.getItemById(id);
        if (i != null) {
            if (completeTable) completeTable.style.visibility='hidden';
            clearAutocompletionResults();
            addCategoryItem($("items_table"),"search", i.id,i.image,i.name,i.description,i.price);
            return;
        }
      }
      var bindArgs = {
            url:  "catalog?command=item&id=" + id,
            mimetype: "text/xml",
            load: function(type, data) {
            loadItemCallback(data);
        }
     };
    dojo.io.bind(bindArgs);
    var completeTable = $("completeTable");
    if (completeTable) completeTable.style.visibility='hidden';
    clearAutocompletionResults();
}

function loadItemCallback(responseXML) {
      var id = responseXML.getElementsByTagName("id")[0].childNodes[0].nodeValue;
      var image = responseXML.getElementsByTagName("image-url")[0].childNodes[0].nodeValue;
      var name = responseXML.getElementsByTagName("name")[0].childNodes[0].nodeValue;
      var description = responseXML.getElementsByTagName("description")[0].childNodes[0].nodeValue;
      var price = responseXML.getElementsByTagName("price")[0].childNodes[0].nodeValue;
      var c = gcats.get("search");
      if (c == null) {
        c= new Category("search", "Search Results");
        gcats.put("search", c);
      }
      c.addItem(id,image,name,description,price);
      addCategoryItem($("items_table"),"search", id,image,name,description,price);
}

function loadCategoryCallback(catid, responseXML) {
	var categories = responseXML.getElementsByTagName("id");
    var catName = responseXML.getElementsByTagName("cat-name")[0].childNodes[0].nodeValue
    var c = new Category(catid,catName);
    for (var loop = 0; loop < categories.length; loop++) {
      var id = responseXML.getElementsByTagName("id")[loop].childNodes[0].nodeValue;
      var image = responseXML.getElementsByTagName("image-url")[loop].childNodes[0].nodeValue;
      var name = responseXML.getElementsByTagName("name")[loop].childNodes[0].nodeValue;
      var description = responseXML.getElementsByTagName("description")[loop].childNodes[0].nodeValue;
      var price = responseXML.getElementsByTagName("price")[loop].childNodes[0].nodeValue;
      c.addItem(id,image,name,description,price);
    }
    gcats.put(catid, c);
    showCategoryItems(catid,0,chunkSize);
}

function inject(p) {
        var targetUrl;
        if (!p.url) targetUrl = "controller?command=content&target=/" + p.template;
        else targetUrl = p.url;
        var templateArgs = {
            url:  targetUrl,
            mimetype: "text/html",
            load: function(type, data) {
               //if no parent is given append to the document root
               if (!p.injectionPoint) {
                    var injectionPoint = document.createElement("div");
                    injectionPoint.innerHTML = data;
                    document.firstChild.appendChild(injectionPoint);
               } else {
                    p.injectionPoint.innerHTML = data;
               }
               if (p.script) {
                  // now load the associated JavaScript
                  var bindArgs = {
                    url:  "controller?command=content&target=/" + p.script,
                    mimetype: "text/javascript",
                    load: function(type,data) {
                        if (p.initFunction) p.initFunction(type,data);
                    }
                  }
                  dojo.io.bind(bindArgs);
               } else {
                  if ( p.initFunction) p.initFunction();
               }
            }
        };
        dojo.io.bind(templateArgs);
}

function resetBody() {
    var body = $("bodyCenter");
    body.innerHTML = "";
}

function showCategoryItems(catid, index, count) {
   inject({template: "items.htmf", injectionPoint: $("bodyCenter"), initFunction: function(){showItems(catid, index,count);}});
}

function showItems(catid, index, count) {
    var itemsTable= $("items_table");
    var c = gcats.get(catid);
    if (c.length == 0) {
        itemsTable.innerHTML = "<tr valign='center'><td class='plainText'>No " + c.name + " available at this time.</td></tr>";
    } else {
        var iTitle = $("items_title");
        iTitle.innerHTML = "<span class='plainText'>" + c.name + "</span>";
           var  loopLength = Number(index) + Number(count);
        for (l = index; l  < loopLength; l++) {
           var i = c.getItem(l);
           addCategoryItem(itemsTable, catid, i.id, i.image,i.name,i.description,i.price);
        }
        if (Number(index) >= chunkSize) {
            var prevIndex =  (Number(index) - chunkSize);
            if ((Number(index)  - Number(chunkSize)) < 0) {
               prevIndex = 0;
            }
            var itemsBottomLeft = $("items_bottom_left");
            itemsBottomLeft.innerHTML = "<a class=\"valueListNavigate\" onclick=\"showCategoryItems('" + catid + "','" + prevIndex + "','" + chunkSize + "')\">Previous</a>";
        }
    }
    if (Number(c.length) > (Number(index) + Number(count)) ) {
        cell = document.createElement("td");
        cell.setAttribute("bgcolor", "white");
        cell.setAttribute("nowrap", "true");
        cell.setAttribute("valign", "top");
        cell.setAttribute("align", "right");
        var link = document.createElement("a");
        link.appendChild(document.createTextNode("Next"));
        link.className = "valueListNavigate";
        var nextCount = count;
        if ((Number(index) + Number(count) + Number(chunkSize)) > Number(c.length)) {
            nextCount = Number(c.length) - (Number(index) + Number(count));
        }
        var itemsBottomRight = $("items_bottom_right");
        itemsBottomRight.innerHTML = "<a class=\"valueListNavigate\" onclick=\"showCategoryItems('" + catid + "','" + (Number(index) + chunkSize) + "','" + nextCount + "')\">Next</a>";
   }
}

 function addCategory(id, name, src) {
    var cell;
    var row;
    var sidebar = document.getElementById("sidebar");
    if (isIE) {
    } else {
        row = document.createElement("tr");
        cell = document.createElement("td");
        cell.setAttribute("nowrap", "true");
        cell.setAttribute("valign", "top");
        var img = document.createElement("img");
        img.src = ("images\\" + src);
        img.setAttribute("height", "50");
        img.setAttribute("width", "50");
        var link = document.createElement("a");
        link.className ="category";
        link.appendChild(document.createTextNode(name));
        var url = "loadCategory('" + id + "')";
        link.setAttribute("onClick", url);
        cell.appendChild(img);
        cell.appendChild(link);
        row.appendChild(cell);
        sidebar.appendChild(row);
    }
}

function addCategoryItem(itemsTable, catid, id,image,name,description,price) {
    var cell;
    var cell2;
    var cell3;
    var row;
    if (isIE) {
        // do ie stuff
    } else {
        row = document.createElement("tr");
        row.setAttribute("bgcolor", "white");
        cell = document.createElement("td");
        cell.setAttribute("bgcolor", "white");
        cell.setAttribute("nowrap", "true");
        cell.setAttribute("valign", "top");
        var img = document.createElement("img");
        img.src = ("images\\" + image);
        cell.appendChild(img);
        row.appendChild(cell);
        cell2 = document.createElement("td");
        cell2.setAttribute("valign", "top");
        var dDiv = document.createElement("div")
        dDiv.appendChild(document.createTextNode(name));
        dDiv.className = "itemName";
        cell2.appendChild(dDiv);
        var dDiv2= document.createElement("div");
        dDiv2.appendChild(document.createTextNode(description));
        dDiv2.className = "item";
        cell2.appendChild(dDiv2);
        row.appendChild(cell2);
        var cell3 = document.createElement("td");
        cell3.setAttribute("valign", "top");
        var dDiv3= document.createElement("div");
        dDiv3.appendChild(document.createTextNode("$" + price + "  "));
        dDiv3.className = "item";
        cell3.appendChild(dDiv3);
        var plink = document.createElement("a");
        plink.className ="purchaseItem";
        plink.appendChild(document.createTextNode("Add to Cart"));
        plink.setAttribute("onClick", "purchaseItem('" + catid + "','" + id + "')");
        cell3.appendChild(plink);
        row.appendChild(cell3);
        itemsTable.appendChild(row);
    }
}

function clearNodes(id) {
    var target = document.getElementById(id);
    if (target) target.innerHTML = "";
}

</script>

</head>
<body>


<table border="0" bordercolor="gray" cellpadding="0" cellspacing="0" bgcolor="white" width="100%">
 <tr id="injectionPoint">
  <td width="100"><img src="images/banner_logo.gif" border="0"></td>
  <td>
  <div class="banner">Petstore</div>
  </td>
  <td align="right">
      <form name="autofillform" action="autocomplete"  onsubmit="return false;">
        <input type="hidden" name="action" value="lookupbyname"/>
         <input    type="text"
                size="15"
                autocomplete="off"
                  id="complete-field"
				name="id"
             onkeyup="doCompletion();">
             <input    type="button"
                  id="search-button"
				value="Search"
             onclick="doSearch();">
    </form>
  </td>
  </td>
 </tr>
  <tr bgcolor="gray">
  <td colspan="3"  align="right">
   <a class="menuLink" onclick="showAccount();">Account</a> <span class="menuItem">|</span > <a class="menuLink" onclick="showCart();">Cart</a> <span class="menuItem">|</span > <a class="menuLink" onclick="showMain();">Main</a>
  </td>
 </tr>
 </table>

 
<table bgcolor="white">
 <tr>
  <td valign="top" width="300"><table id="sidebar" border="0" cellpadding="0">
  <div class="outerbar">

<div dojoType="FisheyeList"
	itemWidth="170" itemHeight="50"
	itemMaxWidth="340" itemMaxHeight="100"
	orientation="vertical"
	effectUnits="2"
	itemPadding="10"
	attachEdge="top"
	labelEdge="bottom"
	enableCrappySvgSupport="false"
>

	<div dojoType="FisheyeListItem" onClick="loadCategory('DOGS');"
		iconsrc="images/dogs_icon.gif" caption="">
	</div>

	<div dojoType="FisheyeListItem" onClick="loadCategory('CATS');"
		iconsrc="images/cats_icon.gif" caption="">
	</div>
    
    <div dojoType="FisheyeListItem" onClick="loadCategory('BIRDS');"
		iconsrc="images/birds_icon.gif" caption="">
	</div>

	<div dojoType="FisheyeListItem" onClick="loadCategory('FISH');"
		iconsrc="images/fish_icon.gif" caption="">
	</div>

	<div dojoType="FisheyeListItem" onClick="loadCategory('REPTILES');"
		iconsrc="images/reptiles_icon.gif" caption="" >
	</div>
</div>

</div></table></td>
  <td valign="top" width="100%">
   <div id="bodyCenter"><h1>Loading....</h1>
  </div>
   </td>
 </td>
 </tr>
</table>

 <div style="position: absolute; visibility: hidden;z-index:5" id="menu-popup">
 <table id="completeTable" class="popupTable" ></table>
 </div>

</body>
</html>